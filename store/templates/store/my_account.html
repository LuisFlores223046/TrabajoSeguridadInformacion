{% extends 'store/main.html' %}
{% load static %}

{% block title %}My Account{% endblock %}

{% block extra_css %}
<style>
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    .field-error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">My Account</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Account Information</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="account-form" novalidate>
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name <span class="text-danger">*</span></label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback">{{ form.first_name.errors.0 }}</div>
                                {% else %}
                                    <div class="invalid-feedback" id="first_name_error"></div>
                                {% endif %}
                                <div class="form-text">Only letters and spaces allowed</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name <span class="text-danger">*</span></label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback">{{ form.last_name.errors.0 }}</div>
                                {% else %}
                                    <div class="invalid-feedback" id="last_name_error"></div>
                                {% endif %}
                                <div class="form-text">Only letters and spaces allowed</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email <span class="text-danger">*</span></label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback">{{ form.email.errors.0 }}</div>
                            {% else %}
                                <div class="invalid-feedback" id="email_error"></div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" value="{{ user.username }}" readonly>
                            <div class="form-text">Username cannot be changed.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback">{{ form.phone.errors.0 }}</div>
                            {% else %}
                                <div class="invalid-feedback" id="phone_error"></div>
                            {% endif %}
                            <div class="form-text">Enter exactly 10 digits without spaces or symbols (optional)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                            {{ form.address }}
                            {% if form.address.errors %}
                                <div class="invalid-feedback">{{ form.address.errors.0 }}</div>
                            {% else %}
                                <div class="invalid-feedback" id="address_error"></div>
                            {% endif %}
                            <div class="form-text">Use only letters, numbers, spaces, commas (,), periods (.), hyphens (-), and # symbol</div>
                        </div>
                        
                        <!-- Mostrar errores no relacionados con campos específicos -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-save me-2"></i>Update Information
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Información adicional de seguridad -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Security Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Last Login:</strong> 
                                {% if user.last_login %}
                                    {{ user.last_login|date:"F j, Y, g:i a" }}
                                {% else %}
                                    Never
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Member Since:</strong> {{ user.date_joined|date:"F j, Y" }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Security Tip:</strong> Keep your account information up to date and use a strong password. 
                        If you notice any suspicious activity, please contact us immediately.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('account-form');
    const submitBtn = document.getElementById('submit-btn');
    
    // Validación en tiempo real para nombres
    function validateName(input) {
        const value = input.value;
        const fieldName = input.name;
        const errorDiv = document.getElementById(fieldName + '_error');
        
        // Remover caracteres no permitidos
        const cleanValue = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/g, '');
        if (value !== cleanValue) {
            input.value = cleanValue;
        }
        
        // Validar formato
        if (cleanValue.length > 0) {
            if (cleanValue.length < 2) {
                showError(input, errorDiv, 'Name must be at least 2 characters.');
                return false;
            } else if (cleanValue.length > 30) {
                showError(input, errorDiv, 'Name cannot exceed 30 characters.');
                return false;
            } else if (/\s{3,}/.test(cleanValue)) {
                showError(input, errorDiv, 'Too many consecutive spaces.');
                return false;
            } else {
                clearError(input, errorDiv);
                return true;
            }
        } else {
            clearError(input, errorDiv);
            return true;
        }
    }
    
    // Validación para teléfono
    function validatePhone(input) {
        const value = input.value;
        const errorDiv = document.getElementById('phone_error');
        
        // Remover todo lo que no sean números
        const cleanValue = value.replace(/[^0-9]/g, '');
        if (value !== cleanValue) {
            input.value = cleanValue;
        }
        
        // Limitar a 10 dígitos
        if (cleanValue.length > 10) {
            input.value = cleanValue.substring(0, 10);
        }
        
        // Validar longitud (opcional, pero si se llena debe ser válido)
        if (cleanValue.length > 0) {
            if (cleanValue.length !== 10) {
                showError(input, errorDiv, 'Phone number must be exactly 10 digits.');
                return false;
            } else {
                clearError(input, errorDiv);
                return true;
            }
        } else {
            clearError(input, errorDiv);
            return true;
        }
    }
    
    // Validación para dirección
    function validateAddress(input) {
        const value = input.value;
        const errorDiv = document.getElementById('address_error');
        
        // Caracteres permitidos: letras, números, espacios, comas, puntos, guiones, #
        const allowedPattern = /^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s,.\-#]*$/;
        
        if (value.length > 0) {
            if (!allowedPattern.test(value)) {
                // Remover caracteres no permitidos
                const cleanValue = value.replace(/[^a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s,.\-#]/g, '');
                input.value = cleanValue;
                showError(input, errorDiv, 'Address contains invalid characters.');
                return false;
            } else if (value.length > 500) {
                showError(input, errorDiv, 'Address cannot exceed 500 characters.');
                return false;
            } else {
                clearError(input, errorDiv);
                return true;
            }
        } else {
            clearError(input, errorDiv);
            return true;
        }
    }
    
    function showError(input, errorDiv, message) {
        input.classList.add('is-invalid', 'field-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
    
    function clearError(input, errorDiv) {
        input.classList.remove('is-invalid', 'field-error');
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
    }
    
    // Event listeners para validación en tiempo real
    const firstNameInput = form.querySelector('input[name="first_name"]');
    const lastNameInput = form.querySelector('input[name="last_name"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const addressInput = form.querySelector('textarea[name="address"]');
    
    if (firstNameInput) {
        firstNameInput.addEventListener('input', function() {
            validateName(this);
        });
    }
    
    if (lastNameInput) {
        lastNameInput.addEventListener('input', function() {
            validateName(this);
        });
    }
    
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            validatePhone(this);
        });
    }
    
    if (addressInput) {
        addressInput.addEventListener('input', function() {
            validateAddress(this);
        });
    }
    
    // Validación al enviar el formulario
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validar todos los campos
        if (firstNameInput && !validateName(firstNameInput)) isValid = false;
        if (lastNameInput && !validateName(lastNameInput)) isValid = false;
        if (phoneInput && !validatePhone(phoneInput)) isValid = false;
        if (addressInput && !validateAddress(addressInput)) isValid = false;
        
        // Validar email
        const emailInput = form.querySelector('input[name="email"]');
        if (emailInput && (!emailInput.validity.valid || emailInput.value.trim() === '')) {
            showError(emailInput, document.getElementById('email_error'), 'Please enter a valid email address.');
            isValid = false;
        } else if (emailInput) {
            clearError(emailInput, document.getElementById('email_error'));
        }
        
        if (!isValid) {
            e.preventDefault();
            
            // Scroll al primer error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            // Deshabilitar botón para prevenir doble envío
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        }
    });
});
</script>
{% endblock %}